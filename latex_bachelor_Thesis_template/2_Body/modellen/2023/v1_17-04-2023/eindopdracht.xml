<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>// Place global declarations here.
// examples v1_12_06_2022 
// examples v1_13_06_2022 

// List one or more processes to be composed into a system.
//system schip,aanvoer,afvoer;
 
//system pomp,pompbediening;   
// for more uppaal documentation https://docs.uppaal.org/language-reference/expressions/

/** Requirementsoverzicht
 * Een sluis heeft deuren voor openenen en sluiten.
 * Een sluis heeft stoplichten met rood en groen waarmee toestemming al dann wel neit wordt gegeven voor schepen voor invaren of uitvaren.
 * Een schip heeft een positie en een doel
 * Een schip kan zich aanmelden
 * De pompbediening handelt de aanvraag van invarende, wachtende en uitvarende schepen af
 * Een schip kan in een wachtrij staan voodat hij een sluis invaart beneden.
 * Een schip kan in een wachtrij staan voodat hij een sluis invaart boven.
 * Een schip kan in een wachtrij staan voordat deze een sluis verlaat.
 * Als een sluis vol is komt een schip automatisch in een wachtrij.
 * Een sluis heeft een pomp(nivelleeersystseem) voor  hoog, midden, laag.
 * Een sluis houdt bij hoeveel schepen invaren.
 * Een sluis houdt bij wat de waterstand is.
 *
 * 
*/

clock realtime,systemtime;
bool entrance_schip,schip_boven=true,schip_beneden=false;
bool direction = false;
const int deuren = 2;
typedef int[0,deuren-1] deur;
bool gate_is_open[deur];
chan open_gate[deur];
chan close_gate[deur];
chan start_stoplicht_uitvaren[entrance_schip];
chan stop_stoplicht_uitvaren[entrance_schip];
chan start_stoplicht_invaren[entrance_schip];
chan stop_stoplicht_invaren[entrance_schip];

bool sluisToggle = false;
bool sluisIsBezig = false;


chan pomp_klik;
chan schipklik;
chan stoplichtklik;
chan deurklik;
//typedef int[0,10] meter;
//meter waterlevel;
const int MAX_schepen=3;
typedef int[0,MAX_schepen-1] kenteken;
const int aantal_stoplichten=4;
typedef int[0,aantal_stoplichten-1] stoplicht;
chan send[0,1],receive[0,1];
int[-1,10] waterlevel=0;
chan notified_pomp_direction[entrance_schip];
// aantal queues voor wachtrij beneden,  de wachtrij boven en  aantal schepen in de sluis
const int aantal_wachtrijen=3;
typedef int[0,aantal_wachtrijen-1] queue_of_ships;
const int SIZE=3;
//queue_of_ships stack[SIZE];
//int myarray[3] := {stack[SIZE], stack[SIZE], stack[SIZE]};
int wachtrij_beneden[SIZE];
//int stack[SIZE];
int wachtrij_boven[SIZE];
//int[0, 2] myarray[stack[SIZE]];
int[-1,6] mystack[SIZE];
//int queues[queue];
typedef int[0, aantal_wachtrijen-1] que;
int queues[que];

int[-1,6] waterniveau = 0;

int[0,1] gatenr;
/////

const int aantal_queues=2;
typedef int[0, aantal_queues-1] queue;


int SIZE_STACK=3;
typedef int wachtrij[SIZE_STACK-1] stack;
/**
const int pompen = 2;
typedef int[0,pompen-1] pomp;

// True is de bovenste gate, false is de onderste




chan boot_aanwezig;

chan toggle_pomp[pomp];


//int queues[queue];




*/

 clock x;</declaration>
	<template>
		<name>maincontroller</name>
		<declaration>// een schip kan zich anamelden bij de sluis(control system); een machine; deze voert bewerkingen uit op de omgeving met informatie van de beheerder
// de sluis bedient de waterpomp,sluisdeur,stoplicht,aanvoer en afvoer van schepen

/** stack
 * de lengte van de datastructuur
*/
const int time_step = 2;




/**
 *
*/
int[0,SIZE] head =0;

/** pop
 *
*/
kenteken pop_left()
{
    kenteken temp;
    temp=stack[--head]; // neem de head voordat we de waarde uitlezen
    stack[head]=0; // verwijder de waarde
    return temp;
    
}


kenteken pop_center()
{
    kenteken temp;
    temp=stack[--head]; // neem de head voordat we de waarde uitlezen
    stack[head]=0; // verwijder de waarde
    return temp;
    
}

kenteken pop_right()
{
    kenteken temp;
    temp=stack[--head]; // neem de head voordat we de waarde uitlezen
    stack[head]=0; // verwijder de waarde
    return temp;
    
}


/** push
 *
*/
void push(kenteken p)
{
    stack[head++]=p;
}


/** isFull
 *
*/
bool isFull()
{
    return (head==SIZE);
}


/** isEmpty
 *
*/
bool isEmpty()
{
 return (head ==0);
}

void reset()
{}</declaration>
		<location id="id0" x="-280" y="0">
			<name x="-290" y="-34">idle</name>
			<label kind="comments" x="-875" y="93">Check realtime clock. Luster naar signalen van de sensors boven en beneden.
Check of sluis leeg is.
Indien sluis niet leeg is dan werk afmaken.
Als sluis leeg is dan positie wachtend schip.
Pomp water in/uit de sluis.
Sluisdeur open.
Stoplcht groen uitvaren.
Schepen laten uitvaren.
Stoplicht rood uitvaren.
Stoplicht groen invaren.
Schepen laten invaren.
Stoplicht rood invaren.
Sluisdeuren sluiten.</label>
		</location>
		<location id="id1" x="442" y="0">
			<label kind="comments" x="569" y="136">verwijder uit de sluiskolk en voeg toe aan de array voor schepen in de wachtrij of beschouw als uuitvarend

To DO
Een uitvarend schip kan niet  worden toegevoegd aan de lijst met wachtende schepen.</label>
		</location>
		<location id="id2" x="884" y="0">
			<name x="892" y="25">empty_queue</name>
			<label kind="invariant" x="901" y="51">queues[direction]&gt;=0 &amp;&amp; x&lt;=time_step</label>
		</location>
		<location id="id3" x="136" y="-136">
			<name x="126" y="-170">water_omhoog</name>
			<label kind="invariant" x="280" y="-187">waterniveau&gt;=0&amp;&amp;x&lt;=time_step</label>
		</location>
		<location id="id4" x="136" y="221">
			<name x="119" y="229">water_omlaag</name>
			<label kind="invariant" x="110" y="255">waterniveau&lt;=5&amp;&amp;x&lt;=time_step</label>
		</location>
		<location id="id5" x="-85" y="0">
			<name x="-153" y="-51">deur_check</name>
			<label kind="comments" x="-68" y="0">verwijder uit de wachtrij en voeg toe aan de array voor schepen in de sluiskolk


myarray[0][0]++,queues[!direction]--, queues[2]++</label>
		</location>
		<init ref="id0"/>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="477" y="-17">open_gate[direction]!</label>
			<nail x="459" y="0"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<label kind="guard" x="-67" y="187">!direction</label>
			<nail x="-85" y="221"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id3"/>
			<label kind="guard" x="-67" y="-170">direction</label>
			<nail x="-85" y="-17"/>
			<nail x="-85" y="-136"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="-440" y="-22">realtime==21</label>
			<label kind="assignment" x="-440" y="12">reset()</label>
			<nail x="-374" y="-34"/>
			<nail x="-374" y="68"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id5"/>
			<label kind="comments" x="127" y="-374">sync:
boot_aanwezig?


update:
sluisToggle:=true,
sluisIsBezig:=true</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id5"/>
			<label kind="guard" x="527" y="272">queues[direction]&lt;=0&amp;&amp;sluisToggle</label>
			<label kind="synchronisation" x="527" y="289">close_gate[direction]!</label>
			<label kind="assignment" x="527" y="306">direction=!direction, sluisToggle:=false</label>
			<nail x="883" y="34"/>
			<nail x="883" y="340"/>
			<nail x="-170" y="340"/>
			<nail x="-170" y="102"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="assignment" x="902" y="0">myarray[direction]++</label>
			<label kind="comments" x="1139" y="-34">guard:
sluisToggle==false &amp;&amp; queues[direction]&lt;=0
sync:
close_gate[direction]!
update:
sluisIsBezig:=false, queues[!direction] := 0</label>
			<nail x="1019" y="0"/>
			<nail x="1019" y="-238"/>
			<nail x="-280" y="-238"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id1"/>
			<label kind="guard" x="484" y="153">waterniveau&gt;=5</label>
			<label kind="synchronisation" x="459" y="178">notified_pomp_direction[direction]!</label>
			<nail x="153" y="221"/>
			<nail x="442" y="221"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id4"/>
			<label kind="assignment" x="102" y="119">waterniveau--, x:=0</label>
			<nail x="102" y="162"/>
			<nail x="170" y="162"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id3"/>
			<label kind="assignment" x="119" y="-68">waterniveau++, x:=0</label>
			<nail x="170" y="-68"/>
			<nail x="102" y="-68"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id1"/>
			<label kind="guard" x="93" y="-204">waterniveau==0</label>
			<label kind="synchronisation" x="212" y="-204">notified_pomp_direction[direction]!</label>
			<nail x="442" y="-136"/>
		</transition>
	</template>
	<template>
		<name>gate</name>
		<parameter>const gatenr gatenummer</parameter>
		<declaration>
clock x;
int[0,1] currentstate;</declaration>
		<location id="id6" x="0" y="0">
		</location>
		<location id="id7" x="306" y="0">
			<name x="296" y="-34">closing</name>
		</location>
		<location id="id8" x="306" y="-204">
			<name x="296" y="-238">open</name>
		</location>
		<location id="id9" x="0" y="-204">
			<name x="-10" y="-238">opening</name>
		</location>
		<init ref="id6"/>
		<transition>
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="assignment" x="18" y="0">gate_is_open[entrance_schip] := false</label>
			<nail x="289" y="0"/>
			<nail x="280" y="0"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="306" y="-119">deurklik!</label>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id8"/>
			<label kind="guard" x="60" y="-238">currentstate==entrance_schip</label>
			<label kind="assignment" x="60" y="-204">gate_is_open[entrance_schip] := true, x:=0</label>
			<nail x="42" y="-204"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="0" y="-136">deurklik!</label>
			<nail x="0" y="-34"/>
		</transition>
	</template>
	<template>
		<name>schip</name>
		<parameter>const kenteken schipid</parameter>
		<declaration>
int positie =0;
clock x;</declaration>
		<location id="id10" x="0" y="-102">
			<name x="-10" y="-136">ildle</name>
		</location>
		<location id="id11" x="0" y="51">
		</location>
		<init ref="id10"/>
		<transition>
			<source ref="id11"/>
			<target ref="id10"/>
			<nail x="8" y="51"/>
			<nail x="170" y="51"/>
			<nail x="170" y="-102"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="0" y="-85">send[kenteken]</label>
			<label kind="assignment" x="0" y="-68">positie: int[0,1]</label>
		</transition>
	</template>
	<template>
		<name>pomp</name>
		<declaration>
clock x;


/**
 * de pomp moet aan de hand van een input paranter weten of hij eerst vullen of wegpompen
*/

/**
 *
*/
void functie()
{
	
}

/**
 *
*/
// een constraint op een bepaalde variabele
bool isForMe()
{
	//if(pompnr &lt; 2 &amp;&amp; waterlevel&lt;6) return true;
	//else if(pompnr&gt;1 &amp;&amp; waterlevel&gt;=6) return true;
	 return false;
}

/**
 *
*/
//pomp omlaag
bool isLaag()
{
	//if(pompnr &lt; 2 &amp;&amp; waterlevel&lt;6) return true;
	//else
    //return false;
}

/**
 *
*/
//pomp omhoog
bool isHoog()
{
    //if(pompnr&gt;1 &amp;&amp; waterlevel&gt;=6) return true;
	//else return false;
}

</declaration>
		<location id="id12" x="0" y="0">
			<name x="-10" y="-34">pomp_uit</name>
			<label kind="comments" x="-620" y="93">ipv aan en uit states kan er ook gekozen worden voor de states laag en hoog</label>
		</location>
		<location id="id13" x="102" y="136">
			<name x="92" y="102">pomp_aan</name>
		</location>
		<init ref="id12"/>
		<transition>
			<source ref="id13"/>
			<target ref="id12"/>
			<label kind="synchronisation" x="18" y="119">pomp_klik!</label>
			<nail x="0" y="136"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="52" y="-17">pomp_klik!</label>
			<nail x="34" y="0"/>
			<nail x="102" y="0"/>
		</transition>
	</template>
	<template>
		<name>sluiskolk</name>
		<parameter>const stack  q</parameter>
		<location id="id14" x="-136" y="68">
			<name x="-146" y="34">idle</name>
		</location>
		<location id="id15" x="0" y="68">
		</location>
		<location id="id16" x="136" y="68">
		</location>
		<transition>
			<source ref="id16"/>
			<target ref="id14"/>
			<label kind="guard" x="-84" y="136">!is_empty()</label>
			<label kind="synchronisation" x="-84" y="153">lock_empty()</label>
			<nail x="102" y="170"/>
			<nail x="-102" y="170"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id16"/>
			<label kind="guard" x="246" y="-8">!is_empty()</label>
			<label kind="synchronisation" x="246" y="25">dequeues()</label>
			<nail x="204" y="-34"/>
			<nail x="204" y="136"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="25" y="42">go_out?</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id15"/>
			<label kind="guard" x="-118" y="34">is_full()</label>
			<label kind="synchronisation" x="-118" y="51">lock_full!</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id14"/>
			<label kind="guard" x="-306" y="42">!is_full()</label>
			<label kind="synchronisation" x="-305" y="67">to_lock[i]?</label>
			<label kind="assignment" x="-305" y="84">enqueue(i)</label>
			<nail x="-204" y="-34"/>
			<nail x="-204" y="136"/>
		</transition>
	</template>
	<template>
		<name>stoplight</name>
		<location id="id17" x="0" y="0">
			<name x="-10" y="-34">rood</name>
		</location>
		<location id="id18" x="136" y="0">
			<name x="126" y="-34">oranje</name>
		</location>
		<location id="id19" x="272" y="0">
			<name x="262" y="-34">groen</name>
		</location>
		<init ref="id17"/>
		<transition>
			<source ref="id18"/>
			<target ref="id18"/>
			<nail x="68" y="-102"/>
			<nail x="212" y="-102"/>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id17"/>
			<nail x="272" y="136"/>
			<nail x="0" y="136"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id19"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="18" y="-17">stoplichtklik?</label>
		</transition>
	</template>
	<template>
		<name>sensor</name>
		<location id="id20" x="0" y="0">
		</location>
		<init ref="id20"/>
		<transition>
			<source ref="id20"/>
			<target ref="id20"/>
			<label kind="select" x="144" y="-51">send_ais : kenteken</label>
			<label kind="synchronisation" x="102" y="-93">send!</label>
			<nail x="51" y="-102"/>
			<nail x="119" y="-42"/>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id20"/>
			<label kind="select" x="-272" y="-76">received_ais : kenteken</label>
			<label kind="synchronisation" x="-85" y="-119">receive?</label>
			<nail x="-8" y="-8"/>
			<nail x="-68" y="-68"/>
			<nail x="0" y="-102"/>
		</transition>
	</template>
	<system>// Place template instantiations here.
//Process = Template();
// List one or more processes to be composed into a system.
system maincontroller,deur,pomp,schip,sensor,stoplicht;
    </system>
	<queries>
		<query>
			<formula>A[] not deadlock</formula>
			<comment></comment>
		</query>
	</queries>
</nta>
