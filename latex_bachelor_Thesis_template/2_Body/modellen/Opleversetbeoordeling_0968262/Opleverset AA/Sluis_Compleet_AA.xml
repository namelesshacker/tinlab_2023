<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>const int deuren = 2;
typedef int[0,deuren-1] deur;

const int aantal_queues=2;
typedef int[0, aantal_queues-1] queue;

const int pompen = 2;
typedef int[0,pompen-1] pomp;

// True is de bovenste gate, false is de onderste
bool direction = false;
bool sluisToggle = false;
bool sluisIsBezig = false;
bool gate_is_open[deur];

chan boot_aanwezig;
chan open_gate[deur];
chan close_gate[deur];
chan toggle_pomp[pomp];

int[-1,6] waterniveau = 0;
int queues[queue];

clock x;



</declaration>
	<template>
		<name>Controller</name>
		<declaration>const int time_step = 2;</declaration>
		<location id="id0" x="323" y="382">
			<name x="340" y="399">queue_legen</name>
			<label kind="invariant" x="187" y="246">queues[direction]&gt;=0 &amp;&amp; x&lt;=time_step</label>
		</location>
		<location id="id1" x="-17" y="382">
		</location>
		<location id="id2" x="-170" y="518">
			<name x="-212" y="535">water_omhoog</name>
			<label kind="invariant" x="-263" y="416">waterniveau&lt;=5&amp;&amp;x&lt;=time_step</label>
		</location>
		<location id="id3" x="-170" y="229">
			<name x="-212" y="178">water_omlaag</name>
			<label kind="invariant" x="-263" y="305">waterniveau&gt;=0&amp;&amp;x&lt;=time_step</label>
		</location>
		<location id="id4" x="-314" y="382">
			<name x="-331" y="348">deur_check</name>
		</location>
		<location id="id5" x="-518" y="382">
			<name x="-535" y="408">idle</name>
		</location>
		<init ref="id5"/>
		<transition>
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="8" y="357">open_gate[direction]!</label>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id5"/>
			<label kind="guard" x="-136" y="76">sluisToggle==false &amp;&amp; queues[direction]&lt;=0</label>
			<label kind="synchronisation" x="-136" y="42">close_gate[direction]!</label>
			<label kind="assignment" x="-136" y="59">sluisIsBezig:=false, queues[!direction] := 0</label>
			<nail x="518" y="382"/>
			<nail x="510" y="102"/>
			<nail x="-518" y="102"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id4"/>
			<label kind="guard" x="-246" y="620">queues[direction]&lt;=0&amp;&amp;sluisToggle</label>
			<label kind="synchronisation" x="-204" y="586">close_gate[direction]!</label>
			<label kind="assignment" x="-255" y="603">direction=!direction, sluisToggle:=false</label>
			<nail x="323" y="586"/>
			<nail x="-518" y="586"/>
			<nail x="-518" y="459"/>
			<nail x="-340" y="391"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="229" y="229">gate_is_open[direction]==true</label>
			<label kind="assignment" x="170" y="212">queues[direction]--, queues[!direction]++, x:=0</label>
			<nail x="408" y="272"/>
			<nail x="229" y="272"/>
			<nail x="297" y="348"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id3"/>
			<label kind="assignment" x="-229" y="289">waterniveau--,x:=0</label>
			<nail x="-212" y="289"/>
			<nail x="-127" y="289"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="assignment" x="-229" y="433">waterniveau++,x:=0</label>
			<nail x="-212" y="459"/>
			<nail x="-127" y="459"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id1"/>
			<label kind="guard" x="0" y="246">waterniveau==0</label>
			<label kind="synchronisation" x="-8" y="229">toggle_pomp[direction]!</label>
			<nail x="-17" y="229"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id1"/>
			<label kind="guard" x="-8" y="484">waterniveau&gt;=5</label>
			<label kind="synchronisation" x="-8" y="467">toggle_pomp[direction]!</label>
			<nail x="-17" y="518"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="guard" x="-484" y="518">!direction &amp;&amp; !gate_is_open[!direction]</label>
			<label kind="synchronisation" x="-467" y="493">toggle_pomp[direction]!</label>
			<label kind="assignment" x="-348" y="476">x:=0</label>
			<nail x="-314" y="518"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="-484" y="212">direction &amp;&amp; !gate_is_open[!direction]</label>
			<label kind="synchronisation" x="-467" y="255">toggle_pomp[direction]!</label>
			<label kind="assignment" x="-348" y="238">x:=0</label>
			<nail x="-314" y="229"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-476" y="323">boot_aanwezig?</label>
			<label kind="assignment" x="-476" y="340">sluisToggle:=true,
sluisIsBezig:=true</label>
		</transition>
	</template>
	<template>
		<name>Gate</name>
		<parameter>deur d</parameter>
		<declaration>const int change_gate_time = 1;
int[-1,6] current_state = 0;

const int closed_gate =  0;
const int opened_gate = 5;</declaration>
		<location id="id6" x="476" y="127">
			<name x="493" y="119">closing</name>
			<label kind="invariant" x="365" y="229">current_state&gt;=0&amp;&amp;x&lt;=change_gate_time</label>
		</location>
		<location id="id7" x="476" y="-34">
			<name x="493" y="-43">open</name>
		</location>
		<location id="id8" x="195" y="-34">
			<name x="125" y="-43">opening</name>
			<label kind="invariant" x="59" y="-144">current_state&lt;=5&amp;&amp;x&lt;=change_gate_time</label>
		</location>
		<location id="id9" x="195" y="127">
			<name x="136" y="119">closed</name>
		</location>
		<init ref="id9"/>
		<transition>
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="assignment" x="425" y="212">x:=0, current_state--</label>
			<nail x="518" y="195"/>
			<nail x="433" y="195"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id8"/>
			<label kind="assignment" x="119" y="-127">x:=0, current_state++</label>
			<nail x="144" y="-102"/>
			<nail x="238" y="-102"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id9"/>
			<label kind="guard" x="263" y="127">current_state==closed_gate</label>
			<label kind="assignment" x="255" y="144">gate_is_open[d] := false</label>
			<nail x="246" y="127"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="484" y="34">close_gate[d]?</label>
			<label kind="assignment" x="484" y="51">x:=0</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="guard" x="238" y="-76">current_state==opened_gate</label>
			<label kind="assignment" x="238" y="-59">gate_is_open[d] := true, x:=0</label>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="93" y="34">open_gate[d]?</label>
			<label kind="assignment" x="136" y="51">x:=0</label>
		</transition>
	</template>
	<template>
		<name>Pump</name>
		<parameter>pomp p</parameter>
		<declaration>clock y;</declaration>
		<location id="id10" x="-612" y="-544">
			<name x="-620" y="-527">pomp_aan</name>
		</location>
		<location id="id11" x="-688" y="-663">
			<name x="-722" y="-697">pomp_uit</name>
		</location>
		<init ref="id11"/>
		<transition>
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="-790" y="-552">toggle_pomp[p]?</label>
			<nail x="-688" y="-544"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id10"/>
			<label kind="synchronisation" x="-603" y="-646">toggle_pomp[p]?</label>
			<nail x="-612" y="-663"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">Request</name>
		<declaration>// Place local declarations here.

const int max_boten =5  ;
</declaration>
		<location id="id12" x="-561" y="-272">
		</location>
		<location id="id13" x="-782" y="-162">
			<committed/>
		</location>
		<location id="id14" x="-782" y="-391">
			<committed/>
		</location>
		<location id="id15" x="-782" y="-272">
		</location>
		<init ref="id15"/>
		<transition>
			<source ref="id12"/>
			<target ref="id15"/>
			<label kind="select" x="-756" y="-306">r_getal : int[1,max_boten]</label>
			<label kind="synchronisation" x="-756" y="-289">boot_aanwezig!</label>
			<label kind="assignment" x="-765" y="-272">queues[direction]:= r_getal</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id12"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id12"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id13"/>
			<label kind="guard" x="-867" y="-246">!sluisIsBezig</label>
			<label kind="assignment" x="-884" y="-229">direction:=false</label>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id14"/>
			<label kind="guard" x="-867" y="-374">!sluisIsBezig</label>
			<label kind="assignment" x="-875" y="-357">direction:=true</label>
		</transition>
	</template>
	<system>// List one or more processes to be composed into a system.
system Request, Pump, Gate, Controller;
    </system>
	<queries>
		<query>
			<formula>A[] !(Gate(0).open and Gate(1).open)</formula>
			<comment>Het is nooit mogelijk dat beide deuren open zijn.</comment>
		</query>
		<query>
			<formula>A&lt;&gt; Controller.deur_check imply Controller.idle </formula>
			<comment>In alle paden leidt deur_check een keer naar de idle state.</comment>
		</query>
		<query>
			<formula>A[] !((Gate(0).open or Gate(1).open) and (Pump(0).pomp_aan or Pump(1).pomp_aan))</formula>
			<comment>Er is in elk pad geen state waarbij een van de deuren open is en een pomp aan is</comment>
		</query>
		<query>
			<formula>A&lt;&gt; (Pump(0).pomp_aan and Pump(1).pomp_aan)</formula>
			<comment>In geen van de paden is het mogelijk om beide pompen aan te hebben</comment>
		</query>
		<query>
			<formula>A[] (queues[0] + queues[1]) &lt;= Request.max_boten</formula>
			<comment>Er is nooit een state waar de queues bij elkaar groter zijn dan de max aantal boten</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (waterniveau==0) or (waterniveau==5)</formula>
			<comment>Het water kan ooit 0 zijn maar ook 5</comment>
		</query>
		<query>
			<formula>A[] not deadlock</formula>
			<comment>Er is geen deadlock</comment>
		</query>
	</queries>
</nta>
